<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>作品投稿 - 鉄路の記憶</title>
<link rel="stylesheet" href="../style.css">
<style>
    body { background: #111; color: #eee; font-family: sans-serif; text-align: center; }
    .post-container { max-width: 500px; margin: 30px auto; padding: 20px; background: #222; border: 1px solid #c5a059; border-radius: 8px; }
    input, textarea { width: 100%; padding: 12px; margin: 10px 0; background: #333; color: #fff; border: 1px solid #444; border-radius: 4px; box-sizing: border-box; }
    .submit-btn { background: #c5a059; color: #0d123e; font-weight: bold; padding: 15px; width: 100%; border: none; cursor: pointer; border-radius: 4px; }
    .submit-btn:disabled { background: #666; opacity: 0.7; }
    #preview { width: 100%; margin: 10px 0; display: none; border: 1px solid #c5a059; }
    .status { font-size: 0.85rem; margin-top: 15px; color: #c5a059; line-height: 1.6; }
</style>
</head>
<body>
<div class="post-container">
    <h2 style="color:#c5a059;">作品提出</h2>
    <form id="post-form">
        <input type="text" id="photo-title" placeholder="作品のタイトル" required>
        <textarea id="photo-desc" placeholder="エピソード（任意）" rows="3"></textarea>
        <input type="file" id="photo-file" accept="image/*" required onchange="previewImage(this)">
        <img id="preview">
        <button type="submit" class="submit-btn" id="sub-btn">出発進行</button>
    </form>
    <div id="upload-status" class="status"></div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-storage.js";
  import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBukPN3ZgMfBbtlMjZpYREhlZMtqUT4d38",
    authDomain: "railway-memory.firebaseapp.com",
    projectId: "railway-memory",
    storageBucket: "railway-memory.firebasestorage.app",
    messagingSenderId: "859129585420",
    appId: "1:859129585420:web:e3e01423b1f8c8a4467329"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const storage = getStorage(app);
  const db = getFirestore(app);

  let currentUser = null;
  onAuthStateChanged(auth, (user) => { if (!user) { location.href = "mypage.html"; } else { currentUser = user; } });

  // 画像をリサイズする関数
  async function resizeImage(file) {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (event) => {
            const img = new Image();
            img.src = event.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const MAX_WIDTH = 1280;
                let width = img.width;
                let height = img.height;

                if (width > MAX_WIDTH) {
                    height *= MAX_WIDTH / width;
                    width = MAX_WIDTH;
                }
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                canvas.toBlob((blob) => resolve(blob), 'image/jpeg', 0.8);
            };
        };
    });
  }

  window.previewImage = (obj) => {
    const reader = new FileReader();
    reader.onload = () => { const p = document.getElementById('preview'); p.src = reader.result; p.style.display = "block"; };
    reader.readAsDataURL(obj.files[0]);
  };

  document.getElementById('post-form').onsubmit = async (e) => {
    e.preventDefault();
    const btn = document.getElementById('sub-btn');
    const status = document.getElementById('upload-status');
    const file = document.getElementById('photo-file').files[0];

    btn.disabled = true;
    status.innerHTML = "石炭投入中... (画像を軽量化しています)";

    try {
        // 1. 画像をリサイズ
        const resizedBlob = await resizeImage(file);
        
        // 2. Storageに保存
        status.innerHTML = "信号確認！送信開始...<br><small>※通常10秒以内に終わります</small>";
        const storageRef = ref(storage, 'entries/' + Date.now() + "_" + currentUser.uid);
        const snapshot = await uploadBytes(storageRef, resizedBlob);
        const url = await getDownloadURL(snapshot.ref);

        // 3. Firestoreに保存
        status.innerHTML = "終着駅接近... (データ登録中)";
        await addDoc(collection(db, "entries"), {
            uid: currentUser.uid,
            userName: currentUser.displayName,
            title: document.getElementById('photo-title').value,
            description: document.getElementById('photo-desc').value,
            imageUrl: url,
            timestamp: serverTimestamp()
        });

        status.innerHTML = "定時到着！投稿が完了しました。";
        setTimeout(() => { location.href = "gallery.html"; }, 1500);

    } catch (err) {
        console.error(err);
        status.innerHTML = "トラブル発生。エラーコード: " + err.code + "<br>通信環境の良い場所で再試行してください。";
        btn.disabled = false;
    }
  };
</script>
<script src="memory-menu.js"></script>
</body>
</html>
