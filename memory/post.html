<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>作品投稿 - 鉄路の記憶</title>
<link rel="stylesheet" href="../style.css">
<style>
    body { background: #111; color: #eee; font-family: sans-serif; text-align: center; }
    .post-container { max-width: 500px; margin: 30px auto; padding: 20px; background: #222; border: 1px solid #c5a059; border-radius: 8px; }
    input, textarea { width: 100%; padding: 12px; margin: 10px 0; background: #333; color: #fff; border: 1px solid #444; border-radius: 4px; box-sizing: border-box; }
    .submit-btn { background: #c5a059; color: #0d123e; font-weight: bold; padding: 15px; width: 100%; border: none; cursor: pointer; border-radius: 4px; }
    .submit-btn:disabled { background: #666; }
    #preview { width: 100%; margin: 10px 0; display: none; border: 1px solid #c5a059; }
    .status { font-size: 0.8rem; margin-top: 15px; color: #c5a059; font-weight: bold; }
</style>
</head>
<body>
<div class="post-container">
    <h2 style="color:#c5a059;">作品提出</h2>
    <form id="post-form">
        <input type="text" id="photo-title" placeholder="作品のタイトル" required>
        <textarea id="photo-desc" placeholder="エピソード（任意）" rows="3"></textarea>
        <input type="file" id="photo-file" accept="image/*" required onchange="previewImage(this)">
        <img id="preview">
        <button type="submit" class="submit-btn" id="sub-btn">出発進行</button>
    </form>
    <div id="upload-status" class="status"></div>
</div>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-storage.js";
  import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";
  const firebaseConfig = {
    apiKey: "AIzaSyBukPN3ZgMfBbtlMjZpYREhlZMtqUT4d38",
    authDomain: "railway-memory.firebaseapp.com",
    projectId: "railway-memory",
    storageBucket: "railway-memory.firebasestorage.app",
    messagingSenderId: "859129585420",
    appId: "1:859129585420:web:e3e01423b1f8c8a4467329"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const storage = getStorage(app);
  const db = getFirestore(app);
  let currentUser = null;
  onAuthStateChanged(auth, (user) => { if (!user) { location.href = "mypage.html"; } else { currentUser = user; } });
  window.previewImage = (obj) => {
    const reader = new FileReader();
    reader.onload = () => { const p = document.getElementById('preview'); p.src = reader.result; p.style.display = "block"; };
    reader.readAsDataURL(obj.files[0]);
  };
  document.getElementById('post-form').onsubmit = async (e) => {
    e.preventDefault();
    const btn = document.getElementById('sub-btn');
    const status = document.getElementById('upload-status');
    const file = document.getElementById('photo-file').files[0];
    btn.disabled = true;
    status.innerText = "写真を送信中... 信号確認...";
    try {
        const storageRef = ref(storage, 'entries/' + Date.now() + "_" + (currentUser ? currentUser.uid : "anon"));
        const snapshot = await uploadBytes(storageRef, file);
        const url = await getDownloadURL(snapshot.ref);
        await addDoc(collection(db, "entries"), {
            uid: currentUser.uid,
            userName: currentUser.displayName,
            title: document.getElementById('photo-title').value,
            description: document.getElementById('photo-desc').value,
            imageUrl: url,
            timestamp: serverTimestamp()
        });
        status.innerText = "投稿完了！";
        setTimeout(() => { location.href = "gallery.html"; }, 1500);
    } catch (err) {
        console.error(err);
        status.innerText = "エラー: " + err.code;
        btn.disabled = false;
    }
  };
</script>
<script src="memory-menu.js"></script>
</body>
</html>
